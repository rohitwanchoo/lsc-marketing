<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerAdmin mailme@rohitwanchoo.com
    ServerName marketing.linkswitchcommunications.com
    ServerAlias marketing.linkswitchcommunications.com

    ErrorLog /var/log/apache2/lsc-marketing-error.log
    CustomLog /var/log/apache2/lsc-marketing-access.log combined

    # ── SSL ────────────────────────────────────────────────────────────
    SSLCertificateFile    /etc/letsencrypt/live/marketing.linkswitchcommunications.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/marketing.linkswitchcommunications.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # ── Proxy settings ─────────────────────────────────────────────────
    ProxyPreserveHost On
    ProxyRequests     Off

    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-For   "%{REMOTE_ADDR}s"

    # ── NextAuth callbacks → Next.js dashboard (port 4002) ────────────
    # Must appear BEFORE the general /api/ rule below
    ProxyPass        /api/auth/      http://127.0.0.1:4002/api/auth/
    ProxyPassReverse /api/auth/      http://127.0.0.1:4002/api/auth/

    # ── Orchestrator API  →  port 4001 ─────────────────────────────────
    # Matches: /api/*, /webhook/*, /trigger/*, /health, /status, /integrations/*
    ProxyPass        /api/           http://127.0.0.1:4001/api/
    ProxyPassReverse /api/           http://127.0.0.1:4001/api/

    ProxyPass        /webhook/       http://127.0.0.1:4001/webhook/
    ProxyPassReverse /webhook/       http://127.0.0.1:4001/webhook/

    ProxyPass        /trigger/       http://127.0.0.1:4001/trigger/
    ProxyPassReverse /trigger/       http://127.0.0.1:4001/trigger/

    ProxyPass        /integrations/  http://127.0.0.1:4001/integrations/
    ProxyPassReverse /integrations/  http://127.0.0.1:4001/integrations/

    ProxyPass        /health         http://127.0.0.1:4001/health
    ProxyPassReverse /health         http://127.0.0.1:4001/health

    ProxyPass        /status         http://127.0.0.1:4001/status
    ProxyPassReverse /status         http://127.0.0.1:4001/status

    # ── Next.js static assets served directly (standalone doesn't serve these) ──
    Alias /_next/static/ /var/www/html/lsc_marketing_automation/dashboard/.next/standalone/.next/static/
    <Directory /var/www/html/lsc_marketing_automation/dashboard/.next/standalone/.next/static/>
        Options -Indexes
        AllowOverride None
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, max-age=31536000, immutable"
    </Directory>

    # Public folder — use RewriteMap to serve files that exist on disk, else proxy
    <Directory /var/www/html/lsc_marketing_automation/dashboard/.next/standalone/public/>
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>

    # ── Next.js Dashboard  →  port 4002 ────────────────────────────────
    RewriteEngine On

    # WebSocket support
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) ws://127.0.0.1:4002/$1 [P,L]

    # Serve public folder files directly if they exist on disk
    RewriteCond /var/www/html/lsc_marketing_automation/dashboard/.next/standalone/public%{REQUEST_URI} -f
    RewriteRule ^/(.*)$ /var/www/html/lsc_marketing_automation/dashboard/.next/standalone/public/$1 [L]

    # Everything else → Next.js dashboard
    ProxyPass        /_next/static/ !
    ProxyPass        /  http://127.0.0.1:4002/
    ProxyPassReverse /  http://127.0.0.1:4002/

</VirtualHost>
</IfModule>
